---
- name: Repository machine - Nexus OSS for cinema artifacts
  hosts: repository_machine
  become: true

  vars:
    nexus_image: "sonatype/nexus3:3.70.1"
    nexus_container_name: "nexus"
    nexus_data_dir: "/home/vagrant/nexus-data"

  tasks:

    - name: Install Docker and curl
      apt:
        name:
          - docker.io
          - curl
        state: present
        update_cache: yes

    - name: Upewnij się, że katalog na dane Nexusa istnieje
      file:
        path: "{{ nexus_data_dir }}"
        state: directory
        owner: 200
        group: 200
        mode: "0755"

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Uruchom kontener Nexus Repository
      docker_container:
        name: "{{ nexus_container_name }}"
        image: "{{ nexus_image }}"
        restart_policy: unless-stopped
        published_ports:
          - "{{ nexus_http_port }}:8081"
        env:
          NEXUS_SECURITY_RANDOMPASSWORD: "false"
        volumes:
          - "{{ nexus_data_dir }}:/nexus-data"

    - name: Czekaj aż Nexus będzie w stanie UP
      uri:
        url: "http://localhost:{{ nexus_http_port }}/service/rest/v1/status"
        method: GET
        status_code: 200
      register: nexus_status
      retries: 60          
      delay: 10
      until: nexus_status.status == 200

    - name: Utwórz RAW hosted repo na artefakty cinema (jeśli jeszcze nie istnieje)
      uri:
        url: "http://localhost:{{ nexus_http_port }}/service/rest/v1/repositories/raw/hosted"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: yes
        status_code: [201, 400]
        return_content: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ nexus_raw_repo_name }}"
          online: true
          storage:
            blobStoreName: "default"
            strictContentTypeValidation: false
            writePolicy: "allow"
      register: create_repo_result
      failed_when: >
        create_repo_result.status not in [201, 400] or
        (
          create_repo_result.status == 400 and
          ('already exists' not in (create_repo_result.content | lower))
        )
      changed_when: create_repo_result.status == 201
