---
- name: Provision PostgreSQL Database
  hosts: all
  become: true
  pre_tasks:
    - name: Ensure base deps for privilege escalation and Postgres modules
      apt:
        update_cache: yes
        name:
          - acl                  # <-- kluczowe! (setfacl/getfacl)
          - sudo                 # zwykle jest, ale dopilnujemy
          - python3-psycopg2     # wymagane przez moduÅ‚y postgresql_*
        state: present

  tasks:
    - name: Ensure apt cache is updated
      apt:
        update_cache: yes

    - name: Install PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
        state: present

    - name: Get PostgreSQL version directory
      command: ls /etc/postgresql
      register: pg_version

    - name: Set config file paths
      set_fact:
        pg_conf_dir: "/etc/postgresql/{{ pg_version.stdout }}/main"
        pg_conf_file: "/etc/postgresql/{{ pg_version.stdout }}/main/postgresql.conf"
        pg_hba_file: "/etc/postgresql/{{ pg_version.stdout }}/main/pg_hba.conf"

    - name: Listen on all interfaces
      lineinfile:
        path: "{{ pg_conf_file }}"
        regexp: '^#?\s*listen_addresses\s*='
        line: "listen_addresses = '*'"

    - name: Disable SSL
      lineinfile:
        path: "{{ pg_conf_file }}"
        regexp: '^#?\s*ssl\s*='
        line: "ssl = off"
        insertafter: EOF

    - name: Allow host connections
      lineinfile:
        path: "{{ pg_hba_file }}"
        line: "{{ item }}"
        state: present
      loop:
        - "host  all  all  10.0.2.2/32        scram-sha-256"
        - "host  all  all  192.168.56.0/24    scram-sha-256"
        - "host  all  all  127.0.0.1/32       scram-sha-256"

    - name: Restart PostgreSQL
      service:
        name: postgresql
        state: restarted

    - name: Set postgres user password
      become_user: "{{ db_user }}"
      postgresql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"

    - name: Create cinema database if not exists
      become_user: "{{ db_user }}"
      postgresql_db:
        name: "{{ db_name }}"
        state: present
        port: "{{ db_port }}"
